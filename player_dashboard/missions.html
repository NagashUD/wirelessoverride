<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Missions</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    body {
      background: url('images/missions.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 2rem;
      color: #ff00ff;
      font-family: 'Orbitron', sans-serif;
      text-shadow: 0 0 5px #ff00ff;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: -1;
    }

    .missions-container {
      
      width: 90%;
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .mission, .special-mission {
      border: 1px solid #ff00ff;
      background-color: rgba(0, 0, 0, 0.6);
      border-radius: 10px;
      padding: 1em;
      color: #fff;
       display: flex;
  flex-direction: row;
    }

        input[type="text"],
    select {
        width: 100%;
        padding: 0.8rem;
        margin-top: 0.5rem;
        background-color: #1a1a1a;
        color: #00ffff;
        border: 2px solid #ff00ff;
        border-radius: 8px;
        font-size: 1rem;
        box-shadow: 0 0 10px #00ffff;
      
    }

    ul {
      list-style: none;
      padding: 0;
    }

    h1, h2, h3 {
      color: #00ffff;
      text-shadow: 0 0 5px #00ffff;
      text-align: center;
    }

.mission-info {
  flex: 1;
  
}

    .mission-card {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
     background-color: rgba(10, 10, 10, 0.9);
     border: 2px solid #ff00ff;
      border-radius: 10px;
      text-align: center;
    box-shadow: 0 0 12px #ff00ff88;
}


.mission-card:hover {
  transform: scale(1.02);
}

.mission-card img {
 width: 100%;
    height: 160px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 12px;
}

.mission-card h3 {
   display: flex;
  flex-direction: row;
  margin: 0;
  font-size: 1.2rem;
   text-align: center;
  
  align-items: center;
  justify-content: center; /* optionnel */
  text-align: center;
}

.mission-details {
  list-style: none;
  padding: 0;
  margin: 0.5rem 0;
  font-size: 0.9rem;
}

        .mission-card button {
            background-color: rgba(51, 51, 51, 0.8);
            color: #fff;
            border: 2px solid #ff00ff;
            padding: 1px 2px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            height: 25%;
            width: 50%;
        }

        .mission-card button:hover {
            background-color: #ff00ff;
            color: #000;
        }

       .mission-card button:after {
            content: '';
            position: absolute;
            width: 100%;
            height: 3px;
            background-color: #00fff7;
            bottom: -5px;
            left: 0;
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.25s ease-out;
        }
       
       .mission-card button:hover:after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

.mission-card.forbidden {
  opacity: 0.6;
  pointer-events: auto;
  border-color: darkred;
}

.mission-card.forbidden button {
  background-color: darkred;
}


#missions-container {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  justify-content: center;
}

.card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
}
.vehicle-container {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 20px;
  margin: 20px 0;
  flex-wrap: wrap; /* Pour que √ßa passe en colonne si √©cran petit */
  
}

.vehicle-box {
 background: rgba(0, 0, 0, 0.7);
  color: #ff00ff;
  border: 1px solid #444;
  border-radius: 8px;
  padding: 15px;
   flex: 1;
  min-width: 300px;
  max-width: 600px;
      border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);

        
      
         
}

.vehicle-box select {

        width: 100%;
        padding: 0.8rem;
        margin-top: 0.5rem;
        background-color: #1a1a1a;
        color: #00ffff;
        border: 2px solid #ff00ff;
        border-radius: 8px;
        font-size: 1rem;
        box-shadow: 0 0 10px #00ffff;
     

}
  .containernouveau {
 background: rgba(0, 0, 0, 0.7);

  border: 1px solid #444;
  border-radius: 8px;
  padding: 15px;
   flex: 1;

      border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);

    
}
.missions-list-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  margin: 30px auto;
  padding: 10px;
  max-width: 1200px;
}
  </style>
</head>
<body>

<!-- Conteneur v√©hicule -->
<div id="vehicle-container" class="vehicle-container">
  
  <!-- Bloc gauche : S√©lection du v√©hicule -->
  <div id="vehicle-select-container" class="vehicle-box left">
    <label for="vehicle-select"><strong>Choisissez votre v√©hicule :</strong></label>
    <select id="vehicle-select"></select>
  </div>

  <!-- Bloc droit : Informations v√©hicule -->
  <div id="vehicle-info-container" class="vehicle-box right">
    <div id="vehicle-info" style="margin-bottom: 10px; font-style: italic;">
      Chargement des informations v√©hicule...
    </div>

    <div id="vehicle-stats">
      <strong>Stats v√©hicule :</strong>
      <ul>
        <li>Carburant restant : <span id="fuel">--</span></li>
        <li>√âtat d‚Äôusure : <span id="wear">--</span></li>
      </ul>
    </div>
  </div>
</div>

<!-- Titre Missions -->
<div class="containernouveau">
  <h1 style="text-align: center;">Missions disponibles</h1>
</div>

<!-- Cartes de missions EN DEHORS -->
<div id="missions-list" class="missions-list-grid">
  <!-- Les missions g√©n√©r√©es dynamiquement -->
</div>




<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCe7dOBqOQfEmBZYWTVv_hZrLYdmQWLi28",
    authDomain: "wirelessoverride.firebaseapp.com",
    projectId: "wirelessoverride",
    storageBucket: "wirelessoverride.appspot.com",
    messagingSenderId: "674723237901",
    appId: "1:674723237901:web:7f9e6e0cc0b2ac21080544"
  };



  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let playerRole = "";
  let rotationTimer = 600;
  const specialCooldowns = {};

  const missions = [
    {
      id: 1,
      titre: "Patrouille urbaine",
      description: "Surveillez les rues et signalez toute activit√© suspecte.",
            image: "images/missions/convoy.jpg",
      roles: ["soldier", "engineer", "medic", "scout", "hacker"],
      baseDuree: 30,
      baseRisque: 10,
      recompense: 100,
      usure: 5,
      special: false
      
    },
    {
      id: 2,
      titre: "Course de livraison",
      description: "Livrer une cargaison dans le temps imparti.",
            image: "images/missions/convoy.jpg",
      roles: ["soldier", "engineer", "medic", "scout", "hacker"],
      baseDuree: 45,
      baseRisque: 15,
      recompense: 150,
      usure: 8,
      special: false
    },
    {
      id: 3,
      titre: "Sauvetage d'urgence",
      description: "Secourir un groupe en danger, mission sp√©ciale √† haut risque.",
            image: "images/missions/convoy.jpg",
      roles: ["medic", "scout"],
      baseDuree: 60,
      baseRisque: 30,
      recompense: 300,
      usure: 12,
      special: true
    }
  ];

  const vehicles = [
    { id: "aucun", nom: "Aucun", modDuree: 4.0, modRisque: 8.0, fuel: 0, wear: 0 },
    { id: "car1", nom: "Moto l√©g√®re", modDuree: 0.8, modRisque: 1.2, fuel: 80, wear: 10 },
    { id: "car2", nom: "Camion robuste", modDuree: 1.3, modRisque: 0.7, fuel: 150, wear: 30 }
  ];

  const vehicleSelect = document.getElementById("vehicle-select");
  const missionsList = document.getElementById("missions-list");
  const specialMissionsList = document.getElementById("special-missions-list");
  const missionTimerEl = document.getElementById("mission-timer");
  const fuelEl = document.getElementById("fuel");
  const wearEl = document.getElementById("wear");

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const uid = user.uid;
      const userDocRef = doc(db, "players", uid);
      const userDocSnap = await getDoc(userDocRef);

      if (userDocSnap.exists()) {
        const userData = userDocSnap.data();
        playerRole = userData.role || "";
        if (!userData.role) console.warn("Aucun r√¥le d√©tect√©, valeur par d√©faut appliqu√©e !");

        await initVehicles();

    
// On s√©lectionne le v√©hicule "aucun" par d√©faut
vehicleSelect.value = "aucun";
setTimeout(() => {
  renderMissions();
}, 0);
      } else {
        console.error("Aucune donn√©e utilisateur trouv√©e !");
      }
    } else {
      window.location.href = "index.html";
    }
  });

  async function initVehicles() {
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    const userRef = doc(db, "players", currentUser.uid);
    const userSnap = await getDoc(userRef);

    if (userSnap.exists()) {
      const userData = userSnap.data();
      const vehicleName = userData.vehicle || "aucun";

      if (vehicleName === "aucun") {
        document.getElementById("vehicle-info").textContent = "Pas de v√©hicule √©quip√©.";
      } else {
        const vehicleQuery = query(collection(db, "vehicles"),
          where("owner", "==", currentUser.uid),
          where("name", "==", vehicleName)
        );
        const querySnapshot = await getDocs(vehicleQuery);
        if (!querySnapshot.empty) {
          const vehicleData = querySnapshot.docs[0].data();
          document.getElementById("vehicle-info").textContent = `V√©hicule √©quip√© : ${vehicleData.name}`;
        }
      }
    }
  }

  function getSelectedVehicle() {
    return vehicles.find(v => v.id === vehicleSelect.value) || vehicles[0];
  }

  function displayVehicleStats(vehicle) {
    fuelEl.textContent = `${vehicle.fuel} litres`;
    wearEl.textContent = `${vehicle.wear} %`;
  }

  function calcMissionStats(mission, vehicle) {
    return {
      duree: Math.round(mission.baseDuree * vehicle.modDuree),
      risque: Math.round(mission.baseRisque * vehicle.modRisque),
      usure: mission.usure
    };
  }

  function displayMissions(vehicle) {
    missionsList.innerHTML = "";

    if (!playerRole) {
      console.warn("R√¥le joueur non d√©fini, impossible d'afficher les missions !");
      return;
    }

    const filtered = missions.filter(m => m.roles.includes(playerRole) && !m.special);

    filtered.forEach(m => {
      const stats = calcMissionStats(m, vehicle);
      const missionCard = document.createElement("div");
      missionCard.className = "mission-card";
      missionCard.innerHTML = `
        <img src="${m.image || 'https://via.placeholder.com/150'}" alt="${m.titre}">
        <div class="mission-info">
          <h3>${m.titre}</h3>
          <p>${m.description}</p>
          <ul class="mission-details">
            <li><strong>‚è≥ Dur√©e :</strong> ${stats.duree} min</li>
            <li><strong>‚ö†Ô∏è Risque :</strong> ${stats.risque} %</li>
            <li><strong>üí∞ R√©compense :</strong> ${m.recompense} cr√©dits</li>
            <li><strong>üîß Usure :</strong> ${stats.usure} %</li>
          </ul>
          <button onclick="alert('Mission accept√©e : ${m.titre}')">Accepter</button>
        </div>
      `;
      missionsList.appendChild(missionCard);
    });
  }

  function displaySpecialMissions(vehicle) {
    specialMissionsList.innerHTML = "";
    const specials = missions.filter(m => m.special && m.roles.includes(playerRole));

    specials.forEach(m => {
      const stats = calcMissionStats(m, vehicle);
      const cd = specialCooldowns[m.id] || 0;
      const btnDisabled = cd > 0 ? "disabled" : "";
      const btnText = cd > 0 ? `D√©bloquable dans ${cd}s` : "Accepter";

      const specialDiv = document.createElement("div");
      specialDiv.className = "special-mission";
      specialDiv.innerHTML = `
        <h3>${m.titre}</h3>
        <p>${m.description}</p>
        <ul>
          <li>Dur√©e : ${stats.duree} minutes</li>
          <li>Risque : ${stats.risque} %</li>
          <li>R√©compense : ${m.recompense} cr√©dits</li>
          <li>Usure v√©hicule : ${stats.usure} %</li>
        </ul>
        <button ${btnDisabled} onclick="alert('Mission sp√©ciale accept√©e : ${m.titre}')">${btnText}</button>
      `;
      specialMissionsList.appendChild(specialDiv);
    });
  }

  function updateTimer() {
    if (rotationTimer > 0) {
      rotationTimer--;
      missionTimerEl.textContent = new Date(rotationTimer * 1000).toISOString().substr(14, 5);
      Object.keys(specialCooldowns).forEach(id => {
        if (specialCooldowns[id] > 0) specialCooldowns[id]--;
      });
      displaySpecialMissions(getSelectedVehicle());
    } else {
      missionTimerEl.textContent = "Rotation en cours...";
      rotationTimer = 600;
    }
  }

  vehicleSelect.addEventListener("change", () => {
    const vehicle = getSelectedVehicle();
    displayVehicleStats(vehicle);
    displayMissions(vehicle);
    displaySpecialMissions(vehicle);
  });

  // Chargement des v√©hicules d√®s que le DOM est pr√™t
document.addEventListener("DOMContentLoaded", () => {
  vehicles.forEach(vehicle => {
    const option = document.createElement("option");
    option.value = vehicle.id;
    option.textContent = vehicle.nom;
    vehicleSelect.appendChild(option);
  });


});

function renderMissions() {
  if (!playerRole) {
    console.warn("Impossible d'afficher les missions : r√¥le non encore d√©fini.");
    return;
  }
  const vehicle = getSelectedVehicle();
  displayVehicleStats(vehicle);
  displayMissions(vehicle);
  displaySpecialMissions(vehicle);
}
</script>

</body>
</html>
