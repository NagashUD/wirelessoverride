<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  <title>√âquipement - Wireless Override</title>
  <style>
    body
    
    {
      background: url('images/equipement.jpg') no-repeat center center fixed;
    background-size: cover;
    text-align: center;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    color: #ff00ff; /* bleu n√©on par d√©faut */
    font-family: 'Orbitron', sans-serif;
    padding: 2rem;
    text-shadow: 0 0 5px #ff00ff;

        }


        body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* filtre assombrissant */
    z-index: -1;
}



.tabs {
            display: flex;
            border-bottom: 2px solid #ccc;
        }

        .tab {
            background-color: rgba(51, 51, 51, 0.8);
    color: #fff;
    border: 2px solid #ff00ff;
    padding: 10px 20px;
    border-radius: 5px;
    font-size: 16px;
    font-weight: bold;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    margin-right: 10px;
        }

        .tab:hover {
            background-color: #ff00ff;
    color: #000;
        }

        .tab.active {
            background-color: #ff00ff;
        }

        nav .tab:after {
             content: '';
    position: absolute;
    width: 100%;
    height: 3px;
    background-color: #00fff7;
    bottom: -5px;
    left: 0;
    transform: scaleX(0);
    transform-origin: bottom right;
    transition: transform 0.25s ease-out;
        }

        nav .tab:hover:after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        .tab-content {
            display: none;
            padding: 20px;
            border-top: none;
        }
        .tab-content.active {
            display: block;
        }

        label {
    display: block;
    margin-top: 1.5rem;
    color: #ff00ff;
    font-weight: bold;
    text-shadow: 0 0 6px #ff00ff;
}

input[type="text"],
select,
textarea {
    width: 100%;
    padding: 0.8rem;
    margin-top: 0.5rem;
    background-color: #1a1a1a;
    color: #00ffff;
    border: 2px solid #ff00ff;
    border-radius: 8px;
    font-size: 1rem;
    box-shadow: 0 0 10px #00ffff;
    text-shadow: 0 0 4px #00ffff;
}

button {
    font-family: 'Orbitron', sans-serif;
    background-color: #ff00ff;
    color: #fff;
    width: 120px;        /* largeur fixe */
    height: 40px;        /* hauteur fixe */
    font-size: 1.1rem;
    letter-spacing: 1px;
    padding: 12px 25px;
    border: none;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
    width: 100%;
    margin-top: 20px;
    box-shadow: 0 0 10px #ff00ff88;
}

button:hover {
    background-color: #00fff7;
}




.inventory-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 15px;
  margin-top: 20px;
  padding: 10px;
  background-color: rgba(20, 20, 20, 0.8);
  border: 2px solid #ff00ff;
  border-radius: 10px;
  box-shadow: 0 0 12px #ff00ff88;
}

.item-coffre-icon{
    width: 64px;
  height: 64px;
  border: 2px solid #ff00ff;
  padding: 10px;
  border-radius: 10px;
  background-color: rgba(30, 30, 30, 0.9);
  box-shadow: 0 0 10px #ff00ff88;
  color: #00ffff;
  text-shadow: 0 0 5px #00ffff;
  font-size: 0.9rem;
    display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.item-card {
    width: 64px;
  height: 64px;
  border: 2px solid #ff00ff;
  padding: 10px;
  border-radius: 10px;
  background-color: rgba(30, 30, 30, 0.9);
  box-shadow: 0 0 10px #ff00ff88;
  color: #00ffff;
  text-shadow: 0 0 5px #00ffff;
  font-size: 0.9rem;
    display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}


.coffre-generic {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 10px;
}

.coffre-slot {
  width: 68px;
  min-height: 68px;
  border: 2px dashed;
  border-radius: 8px;
  background-color: rgba(255, 255, 255, 0.05);
  padding: 10px;
  font-size: 0.85rem;
  text-align: center;
}
.slot {
  width: 68px;
  height: 68px;
  border: 2px solid rgba(255, 255, 255, 0.2); /* contour l√©ger */
  border-radius: 8px;
  margin: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
  background-color: rgba(0, 0, 0, 0.4);
  color: #fff;
  transition: border-color 0.2s ease;
  cursor: grab;
  position: relative;




}

.slot.filled {
 background-color: rgba(0, 0, 0, 0.7);
  border-color: #66ccff;
}

.slot.empty {
    background-color: rgba(0, 0, 0, 0.7);
}

.slot:hover {
  border-color: #00ffff;
  cursor: grab;
  
}

.slot-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  border: 2px solid #444;
  padding: 10px;
    width: 64px;
  height: 64px;
   background-color: rgba(0, 0, 0, 0.8);
  border-radius: 10px;
}
.slot-section {
  margin-bottom: 20px;
}

.inventory-grid, .coffre-generic {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}


  .container {
 background: rgba(0, 0, 0, 0.8);
 margin: 20px;
  border: 1px solid #444;
  border-radius: 8px;
  padding: 15px;
   flex: 1;
  border: 2px solid #ff00ff;
      border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.7);

    
}

  .container2 {
 background: rgba(0, 0, 0, 0.8);
 margin: 20px;
  border: 2px solid #ff00ff;
           box-shadow: 0 0 20px #ff00ff88; /* glow */
  border-radius: 10px;
  padding: 15px;
   flex: 1;
height: 50px;
      border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
  text-align: center;
     justify-content: center; 
       display: flex;
  align-items: center; 
}

    h1 {
        text-align: center;
       font-size: 1.6rem;
        color: #fff; /* rose n√©on */
        
        margin-bottom: 2rem;
    }
        h2 {
        text-align: center;
      font-size: 2.0rem;
        color: #00ffff; 
               text-shadow: 0 0 5px #00ffff;
        
        margin-bottom: 2rem;
    }
    h3 {
        text-align: center;
      font-size: 1.6rem;
        color: #e41515; 
               text-shadow: 0 0 5px #790909;
        
        margin-bottom: 2rem;
    }
    h4 {
        text-align: center;
      font-size: 1.6rem;
        color: #ffffff; 
               text-shadow: 0 0 5px #ffffff;
        
        margin-bottom: 2rem;
    }



    .equipement-wrapper {
  display: flex;
  gap: 40px;
  justify-content: space-between;
  padding: 20px;
}

.colonne-gauche,
.colonne-droite {
  flex: 1;
}

.rarity-common .item-tooltip { border-color: #00d5ff; box-shadow: 0 0 6px #00d5ff; }
.rarity-rare .item-tooltip { border-color: #ff00ff; box-shadow: 0 0 8px #ff00ff; }
.rarity-epic .item-tooltip { border-color: #c91962; box-shadow: 0 0 10px #c91962; }
.rarity-legendary .item-tooltip { border-color: #ffa600; box-shadow: 0 0 12px #ffa600; }


.item {
  position: relative;
  cursor: grab;
  width: 64px;
  height: 64px;
  display: flex;
  justify-content: center;
  align-items: center;
  
}

.item img {
  width: 100%;
  height: 100%;
  object-fit: contain;
    border: 2px solid #ff00ff;
       border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.7);

}

.item-quantite {
  position: absolute;
  bottom: 2px;
  right: 4px;
  font-size: 12px;
  background-color: rgba(0,0,0,0.7);
  color: #00ffff;
  padding: 2px 4px;
  border-radius: 4px;
  font-family: 'Orbitron', sans-serif;
}

.item-tooltip {
  display: none;
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 20;
  background: linear-gradient(145deg, #0f0f0f, #1c1c1c);
  color: #00ffe0;
  padding: 10px;
  border: 2px solid #00ffe0;
  border-radius: 6px;
  font-size: 12px;
  font-family: 'Orbitron', sans-serif;
  box-shadow: 0 0 10px #00ffe0a0;
  white-space: pre-wrap;
  width: 220px;
  transition: opacity 0.2s ease-in-out;
  pointer-events: none;
}

.item:hover .item-tooltip {
  display: block;
  animation: fadeInTooltip 0.2s ease-in-out;
}

@keyframes fadeInTooltip {
  from { opacity: 0; transform: translateX(-50%) translateY(5px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}



.slot.drag-over {
  border: 2px dashed #aaa;
  background-color: rgba(255,255,255,0.1);
}

.alerte-joueur {
  position: fixed;
  top: 30px;
  left: 50%;
  transform: translateX(-50%);
   background-color: rgba(0,0,0,1.0);
  color: #00ffff;
  padding: 12px 28px;
  border: 2px solid #ff00ff;
  border-radius: 8px;
  font-family: 'Orbitron', sans-serif;
  font-size: 18px;
   text-shadow: 0 0 5px #ff00ff;
  box-shadow: 8px #00ffff; 
  opacity: 0;
  transition: opacity 0.4s ease, transform 0.4s ease;
  z-index: 9999;
  pointer-events: none;
}

.alerte-joueur.visible {
  opacity: 1;
  transform: translateX(-50%) scale(1.05);
}

  </style>
</head>
<body>

  <div class="tabs">
    <button class="tab active" data-tab="equip">√âquipements</button>
    <button class="tab" data-tab="base">Stock en Base</button>
    <button class="tab" data-tab="cyber">Cybern√©tiques</button>
    <button class="tab" data-tab="vehicule">Transport</button>
  </div>



<div id="equip" class="tab-content active">
  <div class="container2">
    <h2>√âquipements Actuels</h2>
  </div>

  <div class="equipement-wrapper">
    <!-- Colonne gauche : √©quipements √©quip√©s -->
    <div class="colonne-gauche">
      
   <div class="container">
  <h1>Armes √©quip√©es :</h1>
  <div id="arme-equipee-container" class="coffre-generic"></div> <!-- au lieu de coffre_armes_equipee -->
</div>
      <div class="container">
        <h1>Armures √©quip√©es :</h1>
        <div id="armure-equipee-container" class="coffre-generic"></div>
      </div>
      <div class="container">
        <h1>Munitions √©quip√©es :</h1>
        <div id="munitions-equipee-container" class="coffre-generic"></div>
      </div>
      <div class="container">
        <h1>Cybern√©tiques install√©es :</h1>
        <div id="cybernetiques-installees-container" class="coffre-generic"></div>
      </div>
      <div class="container">
        <h1>Drones √©quip√©s :</h1>
        <div id="drones-equipes-container" class="coffre-generic"></div>
      </div>
    </div>

    <!-- Colonne droite : objets dans le coffre -->
    <div class="colonne-droite">
<div class="container">
  <h1>Armes :</h1>
  <div id="coffre-armes-container" class="coffre-generic" ></div>
</div>
      <div class="container">
        <h1>Armures :</h1>
        <div id="coffre-armures-container" class="coffre-generic"></div>
      </div>
      <div class="container">
        <h1>Munitions :</h1>
        <div id="coffre-munitions-container" class="coffre-generic"></div>
      </div>
      <div class="container">
        <h1>Drones :</h1>
        <div id="coffre-drones-container" class="coffre-generic"></div>
      </div>
    </div>
  </div> <!-- Fin de equipement-wrapper -->

</div> <!-- ICI fermeture manquante de #equip -->



<div id="base" class="tab-content">
  <div class="container2">
    <h2>Stock en Base</h2>
  </div>

  <div class="container">
    <div id="coffre-safe-container">
      <h1>Coffre inventaire s√©curis√©</h1>
      <div id="coffre-safe" class="inventory-grid"></div>
    </div>
  </div>

  <div class="container">
    <div id="coffre-base-container">
      <h1>Inventaire</h1>
      <div id="coffre-base" class="inventory-grid"></div>
    </div>
  </div>
</div>


<div id="cyber" class="tab-content">
  <div class="container2">
    <h2>Implants cybern√©tiques (non install√©s)</h2>
     </div>
      <div class="container2">
    <h3>Installables uniquement via un sp√©cialiste m√©dical.</h3>
     </div>
    

  <div class="container">
    <h1>Implants s√©curis√©s disponibles:</h1>
    <div id="coffre-cyber-safe-container" class="coffre-generic"></div>
  </div>


   <div class="container">
    <h1>Implants disponibles :</h1>
    <div id="coffre-cyber-container" class="coffre-generic"></div>
 </div>
 </div>

<div id="vehicule" class="tab-content">
  <div class="container2">
    <h2>Transport</h2>
  </div>

  <div class="container">
    <h1>V√©hicules en base</h1>
  </div>

  <div class="container">
    <div id="coffre-vehicules-container" class="coffre-generic"></div>
  </div>
</div>


  
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, doc, getDoc ,updateDoc,collection, addDoc, setDoc,getDocs,deleteDoc,deleteField    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";


  const firebaseConfig = {
    apiKey: "AIzaSyCe7dOBqOQfEmBZYWTVv_hZrLYdmQWLi28",
    authDomain: "wirelessoverride.firebaseapp.com",
    projectId: "wirelessoverride",
    storageBucket: "wirelessoverride.appspot.com",
    messagingSenderId: "674723237901",
    appId: "1:674723237901:web:7f9e6e0cc0b2ac21080544"
  };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);


const coffresConfig = {
  coffre_armes: { max: 4 },
  coffre_armures: { max: 4 },
  coffre_base: { max: 7 },
  coffre_cyber: { max: 5 },
  coffre_drones: { max: 2 },
  coffre_munitions: { max: 3 },
  coffre_safe: { max: 3 },
  coffre_safe_cyber: { max: 3 },
  coffre_vehicules: { max: 3 },
  coffre_arme_equipee: { max: 2 },
  coffre_armure_equipee: { max: 4 },
  coffre_munitions_equipee: { max: 2 },
  coffre_drones_equipee: { max: 1 },
  coffre_cybernetiques_installees: { max: 4 }
};

// Map coffre ‚Üí ID conteneur HTML exact
const coffreToContainerMap = {
  coffre_armes: "coffre-armes-container",
  coffre_armures: "coffre-armures-container",
  coffre_base: "coffre-base",  // pas de "-container" dans HTML
  coffre_cyber: "coffre-cyber-container",
  coffre_drones: "coffre-drones-container",
  coffre_munitions: "coffre-munitions-container",
  coffre_safe: "coffre-safe",  // idem pas "-container"
  coffre_safe_cyber: "coffre-cyber-safe-container", // inversion corrig√©e
  coffre_vehicules: "coffre-vehicules-container",
  coffre_arme_equipee: "arme-equipee-container",
  coffre_armure_equipee: "armure-equipee-container",
  coffre_munitions_equipee: "munitions-equipee-container",
  coffre_drones_equipee: "drones-equipes-container",
  coffre_cybernetiques_installees: "cybernetiques-installees-container"
};


// üîê Toujours attendre que l'utilisateur soit bien connect√© :
onAuthStateChanged(auth, async (user) => {
  if (user) {
    playerID = user.uid; // ‚úÖ on l'affecte ici
    console.log("‚úÖ Utilisateur connect√© :", playerID);

    const coffres = await fetchCoffresEtItems(playerID);
    afficherCoffres(coffres);
  } else {
    console.warn("‚ùå Aucun utilisateur connect√©");
  }
});

// Fonction principale pour r√©cup√©rer les coffres et items
async function fetchCoffresEtItems(playerID) {
  const coffres = {};

  const playerRef = doc(db, "players", playerID);
  const playerSnap = await getDoc(playerRef);

  if (!playerSnap.exists()) {
    console.error(`‚ùå Le joueur avec l'ID ${playerID} n'existe pas.`);
    return coffres;
  }

  const data = playerSnap.data();
console.log("üìÑ Donn√©es brutes Firestore :", data);
  for (const [categorie, config] of Object.entries(coffresConfig)) {
    coffres[categorie] = [];

    const slots = data[categorie] || {};
console.log("üì¶ Cat√©gories dans Firestore :", Object.keys(data));
console.log("üìö Cat√©gories attendues :", Object.keys(coffresConfig));
    for (let i = 0; i < config.max; i++) {
      const slotName = `slot${i}`;
      const itemData = slots[slotName];

      if (itemData && itemData.id) {
        coffres[categorie].push({
          slot: slotName,
          ...itemData
        });
        
        console.log(`‚úÖ Item "${itemData.id}" trouv√© dans ${categorie} - ${slotName}`);
      } else if (itemData) {
        console.warn(`‚ö†Ô∏è Item partiel ou sans ID dans ${categorie} - ${slotName}`, itemData);
        coffres[categorie].push({
          slot: slotName,
          ...itemData,
          vide: true
        });
        
      } else {
        coffres[categorie].push({
          slot: slotName,
          vide: true

        });
        
    }  
    }
    console.log("üéí Contenu final des coffres reconstitu√©s :", coffres);
  }

  return coffres;
}

function afficherCoffres(coffres) {
  console.log("üì¶ D√©but de affichage des coffres", coffres);

  Object.keys(coffresConfig).forEach(coffreKey => {
    const containerId = coffreToContainerMap[coffreKey];
    const container = document.getElementById(containerId);

    if (!container) {
      console.warn(`‚ö†Ô∏è Container introuvable pour ${coffreKey} ‚Üí ID attendu : ${containerId}`);
      return;
    }

    console.log(`‚úÖ Container trouv√© : #${containerId}`);
    container.innerHTML = ''; // Reset

    const maxSlots = coffresConfig[coffreKey].max;
    const items = coffres[coffreKey] || [];

    console.log(`‚û°Ô∏è ${coffreKey} contient ${items.length} item(s), ${maxSlots} slot(s)`);

    for (let i = 0; i < maxSlots; i++) {
      const slot = document.createElement('div');
      slot.className = 'slot';
      slot.id = `slot-${coffreKey}-slot${i}`;

  const item = items[i];

// üö´ Si pas d'item valide, on ne g√©n√®re rien
if (!item || !item.id || !item.image) {
  container.appendChild(slot);
  continue;
}

// ‚úÖ Cr√©ation r√©elle d'un item
const itemDiv = document.createElement('div');
itemDiv.className = 'item';
itemDiv.id = `item-${item.id}`;
itemDiv.setAttribute('draggable', 'true');
itemDiv.setAttribute('ondragstart', 'drag(event)');

// Ajout image
const img = document.createElement('img');
img.src = item.image;
img.alt = item.nom || "Objet";
img.className = "item-image";
itemDiv.appendChild(img);

// Raret√©
const rarity = item.rarity || "common";
itemDiv.classList.add(`rarity-${rarity}`);

// Quantit√©
if (item.quantite) {
  const quantiteDiv = document.createElement('div');
  quantiteDiv.className = 'item-quantite'; // üîÅ un seul nom partout
  quantiteDiv.textContent = `x${item.quantite}`;
  itemDiv.appendChild(quantiteDiv);
}

// Tooltip
const tooltipDiv = document.createElement('div');
tooltipDiv.className = 'item-tooltip';
tooltipDiv.innerHTML = `<strong>${item.nom || "Objet"}</strong><br />${item.description || "Pas de description"}`;
itemDiv.appendChild(tooltipDiv);

// Ajout √† la slot
slot.appendChild(itemDiv);
container.appendChild(slot);
    }document.querySelectorAll('.slot').forEach(slot => {
  slot.addEventListener('dragover', allowDrop);
  slot.addEventListener('drop', drop);
});
    
  });

  console.log("‚úÖ Fin de g√©n√©ration des slots.");
}



function renderCoffres(joueurCoffres, catalogue) {
  Object.entries(coffresConfig).forEach(([coffreName, { max }]) => {
    const containerId = coffreToContainerMap[coffreName];
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = ""; // reset

    for (let i = 0; i < max; i++) {
      const slotId = `slot-${coffreName}-slot${i}`;
      const slotDiv = document.createElement("div");
      slotDiv.classList.add("slot");
      slotDiv.id = slotId;
      slotDiv.ondrop = drop;
      slotDiv.ondragover = allowDrop;

      const slotData = joueurCoffres[coffreName]?.[`slot${i}`];
      if (slotData && slotData.id && catalogue[slotData.id]) {
        const item = catalogue[slotData.id];
        const itemDiv = document.createElement("div");
        itemDiv.classList.add("item");
        itemDiv.id = item.id;
        itemDiv.setAttribute("draggable", "true");
        itemDiv.setAttribute("ondragstart", "drag(event)");
        itemDiv.innerHTML = `<img src="${item.image}" alt="${item.nom}" />`;
        itemDiv.addEventListener('dragstart', drag);
        slotDiv.appendChild(itemDiv);
      }

      container.appendChild(slotDiv);
    }
  });
}

let sourceCoffre = null;
let sourceSlotIndex = null;

function drag(event) {
  const draggedItem = event.target.closest('.item');
  if (!draggedItem) return;

  const slotElement = draggedItem.closest('.slot');
  if (!slotElement) return;

  // Extrait coffre et index
  const [_, coffre, slot] = slotElement.id.split("-");
  sourceCoffre = coffre;
  sourceSlotIndex = parseInt(slot.replace("slot", ""), 10);

  event.dataTransfer.setData("text/plain", draggedItem.id);
  console.log(`üéØ dragstart: ${draggedItem.id} de ${sourceCoffre}[${sourceSlotIndex}]`);
}

let playerID = null; 
// ü™Ç Autorise le drop sur une cible
function allowDrop(event) {
  event.preventDefault();
}
// üì• Gestion du drop
async function drop(event) {
  event.preventDefault();

  

  const itemId = event.dataTransfer.getData("text/plain");
  const draggedElement = document.getElementById(itemId);
  const targetSlot = event.target.closest(".slot");

  if (!targetSlot || !draggedElement) return;

const [_, targetCoffre, targetSlotId] = targetSlot.id.split("-");
const targetSlotIndex = parseInt(targetSlotId.replace("slot", ""), 10);

// üõë Emp√™che drop sur le m√™me slot
if (
  sourceCoffre === targetCoffre &&
  sourceSlotIndex === targetSlotIndex
) {
  console.log("üü° Item dropped sur le m√™me slot : aucune action n√©cessaire.");
  return;
}

  const playerRef = doc(db, "players", playerID);
  const playerSnap = await getDoc(playerRef);
  const coffresData = playerSnap.data();

const sourceItem = coffresData[sourceCoffre]?.[`slot${sourceSlotIndex}`];
const targetItem = coffresData[targetCoffre]?.[`slot${targetSlotIndex}`] || null;

if (!sourceItem) {
  console.warn("‚ùå Aucun item √† la source !");
  return;
}

// √âtape 1 : R√©cup√©ration du stockage
const stockage = sourceItem.stockage;

if (stockage && typeof stockage === "object" && Object.keys(stockage).length > 0) {
  console.log("üì¶ Stockage d√©tect√© avec", Object.keys(stockage).length, "entr√©e(s) :");
  for (const [coffre, valeur] of Object.entries(stockage)) {
    console.log(`   ‚Üí ${coffre} : ${valeur}`);
    console.log("üîé Item source brut :", sourceItem);
  }
} else {
  console.warn("‚ö†Ô∏è Aucun champ 'stockage' trouv√© ou objet vide dans l'item source.");
}

  if (!sourceItem) {
    console.warn("‚ùå Aucun item √† la source !");
    return;
  }

const sousCategorie = sourceItem.sous_categorie;

if (!isCompatibleWithCoffre(targetCoffre, sousCategorie)) {
  showDropAlert("‚ùå Cet item ne peut pas aller dans ce coffre !");
  return;
}

  const isStackable = sourceItem.estStockable === true;
const maxStack = targetItem?.stockage?.[targetCoffre] || sourceItem?.stockage?.[targetCoffre] || 1;
console.log("‚úÖ maxStack corrig√© =", maxStack);
  const sourceQuantite = sourceItem.quantite || 1;

  // 1. Fusion de stack
  if (
  isStackable &&
  targetItem &&
  targetItem.nom === sourceItem.nom && // ou codeItem
  targetItem.estStockable
) {
  const targetQuantite = targetItem.quantite || 0;
  const total = sourceQuantite + targetQuantite;
  console.log("üîç maxStack =", maxStack, "targetQuantite =", targetQuantite);
  
  const placeDisponible = maxStack - targetQuantite;

  if (placeDisponible <= 0) {
    showDropAlert(`‚ùå Ce slot est plein pour cet item !`);
    return;
  }

  const nouvelleQuantiteTarget = Math.min(total, maxStack);
  const nouvelleQuantiteSource = total - nouvelleQuantiteTarget;

  const updatePayload = {
    [`${targetCoffre}.slot${targetSlotIndex}.quantite`]: nouvelleQuantiteTarget
  };

  if (nouvelleQuantiteSource > 0) {
    updatePayload[`${sourceCoffre}.slot${sourceSlotIndex}.quantite`] = nouvelleQuantiteSource;
  } else {
    updatePayload[`${sourceCoffre}.slot${sourceSlotIndex}`] = null;
  }

  try {
await updateDoc(playerRef, updatePayload);
console.log("‚úÖ Fusion stack r√©ussie !");

// üîÑ Recharge les coffres depuis Firestore pour affichage propre
const nouveauxCoffres = await fetchCoffresEtItems(playerID);
afficherCoffres(nouveauxCoffres);

  } catch (error) {
    console.error("üî• Erreur fusion Firestore :", error);
  }

  sourceCoffre = null;
  sourceSlotIndex = null;
  return;
}
  // 2. Slot vide
const actionHandled = await handleDropInEmptySlot({
  sourceItem,
  targetItem,
  isStackable,
  sourceQuantite,
  maxStack,
  sourceCoffre,
  sourceSlotIndex,
  targetCoffre,
  targetSlotIndex,
  draggedElement,
  targetSlot,
  playerRef
});

// Slot non vide = switch d'items
if (targetItem && (!isStackable || targetItem.nom !== sourceItem.nom || !targetItem.estStockable)) {
  // √âchange des items dans Firestore
  const updatePayload = {
    [`${targetCoffre}.slot${targetSlotIndex}`]: sourceItem,
    [`${sourceCoffre}.slot${sourceSlotIndex}`]: targetItem
  };

  try {
    await updateDoc(playerRef, updatePayload);
    console.log("‚úÖ Switch d'items r√©ussi !");

    // Recharge les coffres depuis Firestore pour affichage propre
    const nouveauxCoffres = await fetchCoffresEtItems(playerID);
    afficherCoffres(nouveauxCoffres);

  } catch (error) {
    console.error("üî• Erreur switch Firestore :", error);
  }

  sourceCoffre = null;
  sourceSlotIndex = null;

  return;
}

}




window.drag = drag;
window.allowDrop = allowDrop;
window.drop = drop;


function showDropAlert(message) {
  const alertBox = document.createElement("div");
  alertBox.textContent = message;
  alertBox.style.position = "fixed";
  alertBox.style.top = "20px";
  alertBox.style.left = "50%";
  alertBox.style.transform = "translateX(-50%)";
  alertBox.style.background = "#0f0c29";
  alertBox.style.border = "2px solid #00ffff";
  alertBox.style.color = "#ff00ff";
  alertBox.style.padding = "10px 20px";
  alertBox.style.borderRadius = "10px";
  alertBox.style.zIndex = 9999;
  alertBox.style.fontFamily = "Orbitron, sans-serif";
  alertBox.style.boxShadow = "0 0 10px #00ffff";
  alertBox.style.animation = "fadeOut 3s forwards";

  document.body.appendChild(alertBox);
  setTimeout(() => alertBox.remove(), 3000);
}



const compatibiliteCoffres = {
  coffre_armes: ["armes_feu", "armes_lourdes", "armes_melee", "armes_lancees"],
  coffre_munitions: ["armes_munitions", "armes_munitions_lourdes"],
  coffre_drones: ["cyber_drones"],
  coffre_armures: ["armures_tete", "armures_torse", "armures_bras", "armures_jambes"],
  coffre_cyber: ["cyber_optique", "cyber_neurals", "cyber_colonne", "cyber_bras", "cyber_jambes"],
  coffre_safe_cyber: ["cyber_optique", "cyber_neurals", "cyber_colonne", "cyber_bras", "cyber_jambes"],
  coffre_base: ["ressources_energie", "ressources_bricabrac"],
  coffre_safe: ["ressources_energie", "ressources_bricabrac"],
  coffre_vehicules: ["transport_voitures", "transport_motos", "transport_camions", "transport_blindes", "transport_helicos"],
  coffre_arme_equipee: ["armes_feu", "armes_lourdes", "armes_melee", "armes_lancees"],
  coffre_munitions_equipee: ["armes_munitions", "armes_munitions_lourdes"],
  coffre_drones_equipee: ["cyber_drones"],
  coffre_armure_equipee: ["armures_tete", "armures_torse", "armures_bras", "armures_jambes"],
  coffre_cybernetiques_installees: ["cyber_optique", "cyber_neurals", "cyber_colonne", "cyber_bras", "cyber_jambes"]
};

function isCompatibleWithCoffre(targetCoffre, sousCategorie) {
  return compatibiliteCoffres[targetCoffre]?.includes(sousCategorie);
}


async function handleDropInEmptySlot({
  sourceItem,
  targetItem,
  isStackable,
  sourceQuantite,
  maxStack,
  sourceCoffre,
  sourceSlotIndex,
  targetCoffre,
  targetSlotIndex,
  draggedElement,
  targetSlot,
  playerRef,
  playerData
}) {
  const currentTargetItem = playerData?.[targetCoffre]?.[`slot${targetSlotIndex}`];
  if (currentTargetItem && currentTargetItem.id !== sourceItem.id) return false;

  const targetQuantite = currentTargetItem?.quantite || 0;
  const nouvelleQuantiteTarget = sourceQuantite + targetQuantite;

  const updatePayload = {};

  if (isStackable && sourceQuantite > maxStack) {
    updatePayload[`${targetCoffre}.slot${targetSlotIndex}`] = {
      ...sourceItem,
      quantite: maxStack
    };
    updatePayload[`${sourceCoffre}.slot${sourceSlotIndex}.quantite`] = sourceQuantite - maxStack;
  } else {
    updatePayload[`${targetCoffre}.slot${targetSlotIndex}`] = {
      ...sourceItem,
      quantite: nouvelleQuantiteTarget
    };
    updatePayload[`${sourceCoffre}.slot${sourceSlotIndex}`] = null;
  }

try {
  await updateDoc(playerRef, updatePayload);
  console.log("‚úÖ Item d√©plac√© !");

  // üîÑ Recharge les coffres √† jour et r√©affiche proprement tout
  const nouveauxCoffres = await fetchCoffresEtItems(playerRef.id);
  afficherCoffres(nouveauxCoffres);

} catch (error) {
  console.error("üî• Erreur d√©placement Firestore :", error);
}

  return true;
}



























  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Retire la classe active des onglets et contenus
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));

      // Active l'onglet cliqu√© et son contenu correspondant
      tab.classList.add('active');
      const selectedTab = tab.dataset.tab;
      const contentToShow = document.getElementById(selectedTab);
      if (contentToShow) {
        contentToShow.classList.add('active');
      } else {
        console.warn(`‚ö†Ô∏è Contenu introuvable pour l'onglet : ${selectedTab}`);
      }
    });
  });


     </script>
     

</body>
</html>
