<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Magasins ‚Äì Wireless Override</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body
       {
      background: url('images/store.jpg') no-repeat center center fixed;
    background-size: cover;
    text-align: center;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    color: #ff00ff; /* bleu n√©on par d√©faut */
    font-family: 'Orbitron', sans-serif;
    padding: 2rem;
    text-shadow: 0 0 5px #ff00ff;

        }


        body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* filtre assombrissant */
    z-index: -1;
}



.tabs {
            display: flex;
            border-bottom: 2px solid #ccc;
        }

        .tab {
            background-color: rgba(51, 51, 51, 0.8);
    color: #fff;
    border: 2px solid #ff00ff;
    padding: 10px 20px;
    border-radius: 5px;
    font-size: 16px;
    font-weight: bold;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    margin-right: 10px;
        }

        .tab:hover {
            background-color: #ff00ff;
    color: #000;
        }

        .tab.active {
            background-color: #ff00ff;
        }

        nav .tab:after {
             content: '';
    position: absolute;
    width: 100%;
    height: 3px;
    background-color: #00fff7;
    bottom: -5px;
    left: 0;
    transform: scaleX(0);
    transform-origin: bottom right;
    transition: transform 0.25s ease-out;
        }

        nav .tab:hover:after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        .tab-content {
            display: none;
            padding: 20px;
            border-top: none;
        }
        .tab-content.active {
            display: block;
        }

        label {
    display: block;
    margin-top: 1.5rem;
    color: #ff00ff;
    font-weight: bold;
    text-shadow: 0 0 6px #ff00ff;
}

input[type="text"],
select,
textarea {
    width: 100%;
    padding: 0.8rem;
    margin-top: 0.5rem;
      background: rgba(0, 0, 0, 0.7);
    color: #00ffff;
    border: 2px solid #ff00ff;
    border-radius: 8px;
    font-size: 1rem;
    box-shadow: 0 0 10px #00ffff;
    text-shadow: 0 0 4px #00ffff;
}

button {
    font-family: 'Orbitron', sans-serif;
    background-color: #ff00ff;
    color: #fff;
    width: 120px;        /* largeur fixe */
    height: 40px;        /* hauteur fixe */
    font-size: 1.1rem;
    letter-spacing: 1px;
    padding: 12px 25px;
    border: none;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
    width: 100%;
    margin-top: 20px;
    box-shadow: 0 0 10px #ff00ff88;
}

button:hover {
    background-color: #00fff7;
}


.item {
         background: rgba(0, 0, 0, 0.7);
            color:#ff00ff;
            border: 2px solid #ff00ff;
            padding: 1px 2px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            height: 325px;
            width: 250px;
              box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
             flex: 0 1 calc(25% - 1rem); 
      
}


.item:hover {
            background-color: #ff00ff;
            color: #000;
        }

        .item img {
               width: 150px;
  height: 150px;
  margin: 10px 0;
    border: 2px solid #ff00ff;
           box-shadow: 0 0 20px #ff00ff88; /* glow */ 
            border-radius: 8px;
        }
        
        

#btn-acheter {
background-color: rgba(51, 51, 51, 0.8);
            color: #fff;
            border: 2px solid #ff00ff;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
}
#btn-acheter:hover {
       background-color: #ff00ff;
            color: #000;
}
#btn-acheter:after {
            content: '';
            position: absolute;
            width: 100%;
            height: 3px;
            background-color: #00fff7;
            bottom: -5px;
            left: 0;
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.25s ease-out;
        }


     #btn-acheter:hover:after {
       transform: scaleX(1);
            transform-origin: bottom left;
        }







#popup-item {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
   background: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 20px;
  border-radius: 8px;
  z-index: 1000;
  width: 380px;
   height: 600px;
    animation: neonPulse 2.5s ease-in-out infinite;
      display: none;
      
}
#popup-content {

  padding: 20px;
  border-radius: 10px;
  text-align: center;
}

#popup-item img {
  max-width: 120px;
  max-height: 120px;
  object-fit: contain;
  display: block;
  margin: 0 auto 20px;
   border: 2px solid #ff00ff;
     border-radius: 8px;
}



.popup button {
  margin: 10px 5px 0 0;
          background-color: rgba(51, 51, 51, 0.8);
            color: #fff;
            border: 2px solid #ff00ff;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            
}
 .popup button:hover {
            background-color: #ff00ff;
            color: #000;
        }
        
            .popup button:after {
            content: '';
            position: absolute;
            width: 100%;
            height: 3px;
            background-color: #00fff7;
            bottom: -5px;
            left: 0;
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.25s ease-out;
        }

       
          .popup button:hover:after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }


  .container {
 background: rgba(0, 0, 0, 0.8);
 margin: 20px;
  border: 1px solid #444;
  border-radius: 8px;
  padding: 15px;
   flex: 1;

      border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.7);

    
}

  .container2 {
 background: rgba(0, 0, 0, 0.8);
 margin: 20px;
  border: 2px solid #ff00ff;
           box-shadow: 0 0 20px #ff00ff88; /* glow */
  border-radius: 10px;
  padding: 15px;
   flex: 1;
height: 40px;
      border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
  text-align: center;
     justify-content: center; 
       display: flex;
  align-items: center; 
  
}
  .container3 {
 background: rgba(0, 0, 0, 0.8);
 margin: 20px;
  border: 2px solid #ff00ff;
           box-shadow: 0 0 20px #ff00ff88; /* glow */
  border-radius: 10px;
  padding: 15px;
   flex: 1;
height: 20px;
      border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
  text-align: center;
     justify-content: center; 
       display: flex;
  align-items: center; 
  
}

    h1 {
        text-align: center;
       font-size: 1.2rem;
        color: #ff00ff; /* rose n√©on */
        
        margin-bottom: 2rem;
    }
        h2 {
        text-align: center;
      font-size: 2.0rem;
        color: #00ffff; 
               text-shadow: 0 0 5px #00ffff;
        
        margin-bottom: 2rem;
    }
.rupture {
  color: red;
  font-weight: bold;
}
.item.epuise {
   pointer-events: none; /* emp√™che le clic */
  cursor: not-allowed;
}


.stock-timer {
  font-size: 12px;
  color: #ccc;
  margin-bottom: 6px;
  font-style: italic;
}
.stock-timer .countdown {
  font-weight: bold;
  color: #ff5555;
}


  .stock-timer-container {
 background: rgba(0, 0, 0, 0.8);
 margin: 20px;
  border: 1px solid #444;
  border-radius: 8px;
  padding: 15px;
   flex: 1;
      border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
  color: #fff
}



.achat-feedback {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(0, 200, 0, 0.85);
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-weight: bold;
  z-index: 999;
  animation: fadeOut 2s forwards;
}

@keyframes fadeOut {
  0% { opacity: 1; }
  80% { opacity: 1; }
  100% { opacity: 0; transform: translateY(-10px); }
}

.neon-frame {
  border: 1px solid #00faff66;
  box-shadow: 0 0 15px #00faffaa, 0 0 5px #ff00ff88 inset;
}


@keyframes neonPulse {
  0%, 100% {
    box-shadow:
      0 0 8px #00faff,
      0 0 12px #00faff,
      0 0 20px #ff00ff,
      0 0 30px #ff00ff;
  }
  50% {
    box-shadow:
      0 0 2px #00faff,
      0 0 4px #00faff,
      0 0 6px #ff00ff,
      0 0 8px #ff00ff;
  }
}
.stock-list {

  flex-wrap: wrap; /* Permet de passer √† la ligne si trop d‚Äô√©l√©ments */
  gap: 1rem; /* Espacement entre les items */
  justify-content: flex-start; /* ou center, space-between, etc. */
  align-items: flex-start;
  padding: 1rem 0;
    display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* responsive */
  gap: 2rem;
}

        h3 {
        text-align: center;
      font-size: 1.2rem;
        color: #00ffff; 
               text-shadow: 0 0 5px #00ffff;
        
        margin-bottom: 1.2rem;
    }

        h4 {
        text-align: center;
      font-size: 1.2rem;
        color: #ff00ff; 
               text-shadow: 0 0 5px #ff00ff;
        
        margin-bottom: 1.2rem;
    }

.popup-vente {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
   background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 20px;
  border-radius: 8px;
  z-index: 1000;
  width: 380px;
   height: 550px;
    animation: neonPulse 2.5s ease-in-out infinite;
      display: none;
}


.popup-vente.show {

  padding: 20px;
  border-radius: 10px;
  text-align: center;

}


.popup-vente img {
  max-width: 100px;
  max-height: 100px;
  object-fit: contain;
  display: block;
  margin: 0 auto 20px;
   border: 2px solid #ff00ff;
     border-radius: 8px;
}
.item-card {
           background: rgba(0, 0, 0, 0.8);
            color:white;
            border: 2px solid #ff00ff;
            padding: 1px 2px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            height: 400px;
            width: 250px;
              box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
             flex: 0 1 calc(25% - 1rem); 
              flex-wrap: wrap; /* Permet de passer √† la ligne si trop d‚Äô√©l√©ments */

      
}
     .item-card img {
               width: 100px;
  height: 100px;
  margin: 10px 0;
    border: 2px solid #ff00ff;
           box-shadow: 0 0 20px #ff00ff88; /* glow */ 
            border-radius: 8px;
        }
        .item-card:hover {
            background-color: #ff00ff;
            color: #000;
        }
        .item-card.epuise {
  opacity: 0.5;
  pointer-events: none;
  cursor: not-allowed;
  border: 2px solid red;
  border-radius: 8px;
  background-color:  #000;;
}

.items-container {
 flex-wrap: wrap; /* Permet de passer √† la ligne si trop d‚Äô√©l√©ments */
  gap: 1rem; /* Espacement entre les items */
  justify-content: flex-start; /* ou center, space-between, etc. */
  align-items: flex-start;
  padding: 1rem 0;
    display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* responsive */
  gap: 2rem;

}

#btn-annuler {
   background-color: rgba(51, 51, 51, 0.8);
            color: #fff;
            border: 2px solid #ff00ff;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
}
#btn-annuler:hover {
                background-color: #ff00ff;
            color: #000;
}
          #btn-annuler:after {
                      content: '';
            position: absolute;
            width: 100%;
            height: 3px;
            background-color: #00fff7;
            bottom: -5px;
            left: 0;
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.25s ease-out;
        }
     #btn-annuler:hover:after {
       transform: scaleX(1);
            transform-origin: bottom left;
        }
       
   
       .validerventebtn {
   background-color: rgba(51, 51, 51, 0.8);
            color: #fff;
            border: 2px solid #ff00ff;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
}
.validerventebtn:hover {
             background-color: #ff00ff;
            color: #000;
              
}
         .validerventebtn:after {
                 content: '';
            position: absolute;
            width: 100%;
            height: 3px;
            background-color: #00fff7;
            bottom: -5px;
            left: 0;
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.25s ease-out;
        }
               .validerventebtn:hover:after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

.achat-feedback {
  opacity: 0;
  transition: opacity 0.3s ease;
}
.achat-feedback.visible {
  opacity: 1;
}
  </style>
</head>
<body>



  <div class="tabs">
    <button class="tab active" data-onglet="armes">Armes</button>
    <button class="tab" data-onglet="armures">Armures</button>
    <button class="tab" data-onglet="cyber">Cybern√©tiques</button>
       <button class="tab" data-onglet="ressources">Ressources</button>
    <button class="tab" data-onglet="transport">V√©hicules</button>
    <button class="tab" data-onglet="revendre">Revendre</button>

  </div>

<!-- üî´ Magasin d'Armes -->
<div id="armes" class="tab-content active">
  <div class="container2">
    <h2>Magasin d'Armes</h2>
  </div>

  <form>
    <label for="sous-categorie-armes"></label>
    <select id="sous-categorie-armes" class="sous-categorie-select" data-categorie="armes">
      <option value="">Toutes</option>
      <option value="armes_feu">Armes √† feu</option>
      <option value="armes_lourdes">Armes lourdes</option>
      <option value="armes_munitions">Munitions</option>
      <option value="armes_munitions_lourdes">Munitions pour armes lourdes</option>
      <option value="armes_melee">Armes de m√©l√©e</option>
      <option value="armes_lancees">Armes de lancer</option>
    </select>
  </form>

  <div id="armes" class="tab-content active"></div>
  <div class="stock-timer" style="margin: 20px; padding: 10px; background-color: rgba(0, 0, 0, 0.8); color: #fff; border: 1px solid #444; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);">
  <div class="countdown-label" style="font-weight: bold; font-size: 1.2rem;">Chargement du timer...</div>
  <div class="countdown" style="font-size: 2rem; margin-top: 8px;">--:--:--</div>
</div>

  <div id="conteneur-armes" class="stock-list" data-categorie="armes"></div>




</div>

<!-- üõ°Ô∏è Magasin d'Armures -->
<div id="armures" class="tab-content">
  <div class="container2">
    <h2>Magasin d'Armures</h2>
  </div>


  <form>
    <label for="sous-categorie-armures"></label>
    <select id="sous-categorie-armures" class="sous-categorie-select" data-categorie="armures">
      <option value="">Toutes</option>
      <option value="armures_tete">T√™te</option>
      <option value="armures_torse">Torse</option>
      <option value="armures_bras">Bras</option>
      <option value="armures_jambes">Jambes</option>
    </select>
  </form>
  <div id="armures" class="tab-content active"></div>
  <div class="stock-timer" style="margin: 20px; padding: 10px; background-color: rgba(0, 0, 0, 0.8); color: #fff; border: 1px solid #444; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);">
  <div class="countdown-label" style="font-weight: bold; font-size: 1.2rem;">Chargement du timer...</div>
  <div class="countdown" style="font-size: 2rem; margin-top: 8px;">--:--:--</div>
</div>


  <div id="conteneur-armures" class="stock-list" data-categorie="armures"></div>
</div>

<!-- üß† Cybern√©tiques -->
<div id="cyber" class="tab-content">
  <div class="container2">
    <h2>Cybern√©tiques</h2>
  </div>

  <form>
    <label for="sous-categorie-cyber"></label>
    <select id="sous-categorie-cyber" class="sous-categorie-select" data-categorie="cyber">
      <option value="">Tous</option>
      <option value="cyber_drones">Drones</option>
      <option value="cyber_optique">Optiques cybern√©tiques</option>
      <option value="cyber_neurals">Implants Neuronaux</option>
      <option value="cyber_colonne">Colonne Vert√©brale Cybern√©tique</option>
      <option value="cyber_bras">Bras Bioniques</option>
      <option value="cyber_jambes">Jambes Bioniques</option>
         </select>
  </form>

  <div id="cyber" class="tab-content active"></div>
  <div class="stock-timer" style="margin: 20px; padding: 10px; background-color: rgba(0, 0, 0, 0.8); color: #fff; border: 1px solid #444; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);">
  <div class="countdown-label" style="font-weight: bold; font-size: 1.2rem;">Chargement du timer...</div>
  <div class="countdown" style="font-size: 2rem; margin-top: 8px;">--:--:--</div>
</div>

  <div id="conteneur-cyber" class="stock-list" data-categorie="cyber"></div>
</div>

<!-- üåê Ressources -->
<div id="ressources" class="tab-content">
  <div class="container2">
    <h2>Ressources</h2>
  </div>

  <form>
    <label for="sous-categorie-ressources"></label>
    <select id="sous-categorie-ressources" class="sous-categorie-select" data-categorie="ressources">
      <option value="">Toutes</option>
      <option value="ressources_energie">√ânergie</option>
      <option value="ressources_bricabrac">Bric-√†-brac</option>
    </select>
  </form>

  <div id="ressources" class="tab-content active"></div>
  <div class="stock-timer" style="margin: 20px; padding: 10px; background-color: rgba(0, 0, 0, 0.8); color: #fff; border: 1px solid #444; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);">
  <div class="countdown-label" style="font-weight: bold; font-size: 1.2rem;">Chargement du timer...</div>
  <div class="countdown" style="font-size: 2rem; margin-top: 8px;">--:--:--</div>
</div>

  <div id="conteneur-ressources" class="stock-list" data-categorie="ressources"></div>
</div>

<!-- üöó Transport -->
<div id="transport" class="tab-content">
  <div class="container2">
    <h2>V√©hicules</h2>
  </div>

  <form>
    <label for="sous-categorie-transport"></label>
    <select id="sous-categorie-transport" class="sous-categorie-select" data-categorie="transport">
      <option value="">Tous</option>
      <option value="transport_voitures">Voitures</option>
      <option value="transport_motos">Motos</option>
      <option value="transport_camions">Camions</option>
      <option value="transport_blindes">Blind√©s</option>
      <option value="transport_helicos">H√©licopt√®res</option>
    </select>
  </form>

  <div id="transport" class="tab-content active"></div>
  <div class="stock-timer" style="margin: 20px; padding: 10px; background-color: rgba(0, 0, 0, 0.8); color: #fff; border: 1px solid #444; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);">
  <div class="countdown-label" style="font-weight: bold; font-size: 1.2rem;">Chargement du timer...</div>
  <div class="countdown" style="font-size: 2rem; margin-top: 8px;">--:--:--</div>
</div>

  <div id="conteneur-transport"  class="stock-list" data-categorie="transport"></div>
</div>




<!-- ‚ôªÔ∏è Revendre -->

<div id="revendre" class="tab-content">
  <div class="container2">
    <h2>Revendre</h2>
  </div>

  <label for="categorie-select"></label>
  <select id="categorie-select" onchange="chargerItems()">
    <option value="">Veuillez choisir une cat√©gorie</option>
    <option value="coffre_armes">Armes</option>
    <option value="coffre_munitions">Munitions</option>
    <option value="coffre_armures">Armures</option>
    <option value="coffre_cyber">Cybern√©tiques</option>
       <option value="coffre_drones">Drones</option>
     <option value="coffre_base">Ressources</option>
    <option value="coffre_vehicules">V√©hicules</option>
  </select>

  <div id="items-container" class="items-container"></div>




  <!-- üîÅ Popup VENTE -->
<div class="popup-vente">
  <div class="popup-content" onclick="event.stopPropagation()">
    <h2 id="popup-nom-revente">Objet</h2>
    <p>Quantit√© √† vendre : <span id="quantite-valeur-revente">1</span></p>
    <input type="range" min="1" max="1" value="1" id="slider-revente" oninput="updateQuantiteRevente(this.value)">
    <p>Cr√©dits gagn√©s : <span id="gain-valeur-revente">0</span></p>
    <button onclick="validerVente()" class="validerventebtn">Valider la vente</button>
    <button onclick="fermerPopupRevente()" class="validerventebtn" id="btn-fermer-popup">Annuler</button>
  </div>
  </div>
 </div>





<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getDatabase, ref, get, set, update, onValue, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteField, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // Configuration Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCe7dOBqOQfEmBZYWTVv_hZrLYdmQWLi28",
    authDomain: "wirelessoverride.firebaseapp.com",
    projectId: "wirelessoverride",
     databaseURL: "https://wirelessoverride-default-rtdb.europe-west1.firebasedatabase.app/",
    storageBucket: "wirelessoverride.appspot.com",
    messagingSenderId: "674723237901",
    appId: "1:674723237901:web:7f9e6e0cc0b2ac21080544"
  };
  // Initialisation Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const firestore = getFirestore(app);
const realtimeDB = getDatabase();
   // ‚úÖ ici la vraie initialisation Firestore
// Initialisation Firebase
  let currentCategorie = "";
  let currentItemID = "";
  let currentPrixUnitaire = 0;
  let itemSelectionne = null;
  let quantite = 1;
  let itemMax = 1;
  let itemPrix = 0;


const mappingCategorieToCoffre = {
  armes: "coffre_armes",
  armures: "coffre_armures",
  cyber: "coffre_cyber",
  ressources: "coffre_base",
  transport: "coffre_vehicules",
  munitions: "coffre_munitions",
   drones: "coffre_drones"
};

const sousCategories = {
  armes: ["armes_feu","armes_lourdes", "armes_melee", "armes_munitions", "armes_munitions_lourdes","armes_lancees"],
  armures: ["armures_tete", "armures_torse", "armures_bras", "armures_jambes"],
  cyber: ["cyber_drones", "cyber_optique", "cyber_neurals", "cyber_colonne", "cyber_bras", "cyber_jambes"],
  ressources: ["ressources_energie", "ressources_bricabrac"],
  transport: ["transport_voitures", "transport_motos", "transport_camions", "transport_blindes", "transport_helicos"],
};

const labels = {
  armes_feu: "Armes √† Feu",
  armes_lourdes: "Armes lourdes",
  armes_melee: "Armes de m√©l√©e",
  armes_munitions: "Munitions",
  armes_munitions_lourdes: "Munitions pour armes lourdes",
  armes_lancees: "Armes de lancement",
  armures_tete: "T√™te",
  armures_torse: "Torse",
  armures_bras: "Bras",
  armures_jambes: "Jambes",
  cyber_drones: "Drones",
  cyber_optique: "Optiques cybern√©tiques", 
  cyber_neurals: "Implants Neuronaux",
  cyber_colonne: "Colonne Vert√©brale Cybern√©tique",
  cyber_bras: "Bras Bioniques",
  cyber_jambes: "Jambes Bioniques",
  ressources_energie: "√ânergie",
  ressources_bricabrac: "Bric-√†-brac",
  transport_voitures: "Voitures",
  transport_motos: "Motos",
  transport_camions: "Camions",
  transport_blindes: "Blind√©s",
  transport_helicos: "H√©licopt√®res",
};




onAuthStateChanged(auth, user => {
  if (user) {
    currentUID = user.uid;
    console.log("üîê Utilisateur connect√© :", currentUID);

    // S√©lecteurs de sous-cat√©gorie
    const selects = document.querySelectorAll(".sous-categorie-select");

    selects.forEach(select => {
      const categorie = select.dataset.categorie;

      // √âcoute le changement de sous-cat√©gorie
      select.addEventListener("change", () => {
        const sousCategorie = select.value;
        afficherItemsCategorie(categorie, sousCategorie);
      });

      // Affiche les items d√®s l'ouverture (par d√©faut "toutes" ou la valeur actuelle)
      afficherItemsCategorie(categorie, select.value);
      chargerItems(currentUID);
    });
  }
});

// üîÅ Fonction pour charger dynamiquement les options d‚Äôun <select>
function chargerSousCategories(selectElement, categorie) {
  const chemin = `stock-list/${categorie}`;
  const refSousCat = ref(db, chemin);

  get(refSousCat).then(snapshot => {
    if (!snapshot.exists()) {
      selectElement.innerHTML = `<option value="${categorie}">Toutes</option>`;
      afficherItemsCategorie(categorie); // afficher tous les items
      return;
    }

    const data = snapshot.val();
    const sousCategories = Object.keys(data);

    // Cas o√π il n‚Äôy a pas de sous-cat√©gories, juste des items
    const contientItemsDirectement = sousCategories.some(key => typeof data[key] === "object" && "nom" in data[key]);

    if (contientItemsDirectement) {
      selectElement.innerHTML = `<option value="${categorie}">Toutes</option>`;
      afficherItemsCategorie(categorie); // afficher tous les items
    } else {
      // Ajoute chaque sous-cat√©gorie
      let options = `<option value="${categorie}">Toutes</option>`;
      sousCategories.forEach(sousCat => {
        options += `<option value="${sousCat}">${labels[sousCat] || sousCat}</option>`;
      });
      selectElement.innerHTML = options;

      // On affiche les items de la premi√®re option
      const defaultSousCat = selectElement.value;
      afficherItemsCategorie(categorie, defaultSousCat);
    }
  }).catch(error => {
    console.error(`Erreur lors du chargement des sous-cat√©gories de ${categorie} :`, error);
  });
}



// üîí √âchappe les caract√®res HTML pour √©viter les injections
function escapeHtml(text) {
  const map = {
    '&': '&amp;', '<': '&lt;', '>': '&gt;',
    '"': '&quot;', "'": '&#039;'
  };
  return text?.toString().replace(/[&<>"']/g, m => map[m]) || '';
}

// üîÅ Fonction principale de chargement et d'affichage



async function afficherItemsCategorie(categorie, sousCategorie = "toutes") {
  console.log(`üîç Chargement des items - Cat√©gorie : "${categorie}", Sous-cat√©gorie : "${sousCategorie}"`);

  const displayZone = document.querySelector(`.stock-list[data-categorie="${categorie}"]`);
  if (!displayZone) {
    console.warn(`‚ö†Ô∏è Zone d'affichage introuvable pour la cat√©gorie : ${categorie}`);
    return;
  }

  displayZone.innerHTML = `<p>Chargement des items...</p>`;

  const db = getDatabase();
  const chemin = `stock-list/${categorie}`;

  try {
    const snapshot = await get(ref(db, chemin));
    if (!snapshot.exists()) {
      displayZone.innerHTML = `<p>Aucun item trouv√©.</p>`;
      return;
    }

    const data = snapshot.val();
    const items = [];

    // üîé Filtrage des items selon la sous-cat√©gorie s√©lectionn√©e
    Object.entries(data).forEach(([id, item]) => {
      const itemSousCat = item.sous_categorie || "";
      if (
        sousCategorie === "toutes" ||
        !sousCategorie ||
        itemSousCat === sousCategorie
      ) {
        items.push({ id, ...item });
      }
    });

    if (items.length === 0) {
      displayZone.innerHTML = `<p>Aucun item disponible dans cette sous-cat√©gorie.</p>`;
      return;
    }

    // üì¶ R√©cup√©ration des stocks pour chaque item
    const stocks = await Promise.all(
      items.map(item => getStockItem(categorie, item.id))
    );

    // üß± Construction du HTML des cartes
    displayZone.innerHTML = items.map((item, index) => {
      const stock = stocks[index] ?? 0;
      const estEpuise = stock <= 0;
      const classes = `item-card${estEpuise ? " epuise" : ""}`;
      const nomClasse = estEpuise ? "rupture" : "";

      return `
        <div class="${classes}" data-item-id="${escapeHtml(item.id)}" style="pointer-events: ${estEpuise ? "none" : "auto"};">
          ${item.image ? `<img src="${escapeHtml(item.image)}" alt="${escapeHtml(item.nom)}" />` : ""}
          <h3 class="${nomClasse}">${escapeHtml(item.nom || "Objet sans nom")}</h3>
          <p>${escapeHtml(item.description || "Pas de description.")}</p>
          <p><strong>${escapeHtml(item.prix || 0)} cr√©dits</strong></p>
          <p><small>Stock restant : <strong>${stock}</strong></small></p>
        </div>
      `;
    }).join('');

    // üñ±Ô∏è Ajout des √©v√©nements de clic (sauf pour les items √©puis√©s)
    const cartes = displayZone.querySelectorAll(".item-card:not(.epuise)");
    cartes.forEach(carte => {
      const itemId = carte.getAttribute("data-item-id");
      const itemData = items.find(it => it.id === itemId);
      carte.addEventListener("click", () => {
        afficherPopupItem(itemData, itemId, categorie);
      });
    });

    console.log(`‚úÖ ${cartes.length} items affich√©s (sur ${items.length} au total).`);
  } catch (error) {
    console.error("‚ùå Erreur lors du chargement :", error);
    displayZone.innerHTML = `<p>Erreur de chargement des items.</p>`;
  }
}


let currentUID = null;

async function afficherPopupItem(item, itemId, categorie) {
  console.log("üì¶ afficherPopupItem appel√© avec :", item, itemId, categorie);

  const popup = document.getElementById("popup-item");
  if (!popup) {
    console.warn("‚ö†Ô∏è Popup introuvable dans le DOM !");
    return;
  }

  const contenu = popup.querySelector(".popup-contenu");
  if (!contenu) {
    console.warn("‚ö†Ô∏è √âl√©ment .popup-contenu introuvable !");
    return;
  }

  const prix = item.prix ?? 0;
  const stock = item.stock ?? 0;

  // Charge le solde du joueur via Firestore
  await chargerCreditsViaFirestore();

  // Injection du contenu HTML dans la popup
  contenu.innerHTML = `
    <img src="${escapeHtml(item.icone || item.image || 'images/default.png')}" alt="${escapeHtml(item.nom || 'Objet')}" />
    <h3>${escapeHtml(item.nom || '')}</h3>
    <p>${escapeHtml(item.description || '')}</p>
    <p><strong>Prix unitaire :</strong> ${escapeHtml(prix)} cr√©dits</p>
    <p id="solde-joueur"><strong>Votre solde :</strong> ${joueurCredits ?? 0} cr√©dits</p>
    <p>Stock restant : <strong>${stock}</strong></p>

    <label for="slider-achat">Quantit√© : <span id="quantite-valeur-achat">1</span></label>
    <input type="range" id="slider-achat" min="1" max="${stock}" value="1" />

    <p><strong>Prix total :</strong> <span id="prix-total-achat">${prix}</span> cr√©dits</p>

    <button id="btn-acheter">Acheter</button>
    <button id="btn-annuler">Annuler</button>
  `;

  // S√©lection des √©l√©ments HTML
  const slider = contenu.querySelector("#slider-achat");
  const quantiteValeur = contenu.querySelector("#quantite-valeur-achat");
  const prixTotal = contenu.querySelector("#prix-total-achat");

  // Gestion du slider de quantit√©
  slider.addEventListener("input", (e) => {
    const quantite = parseInt(e.target.value);
    quantiteValeur.textContent = quantite;
    prixTotal.textContent = quantite * prix;
  });

  // Clic sur le bouton "Acheter"
  contenu.querySelector("#btn-acheter").addEventListener("click", async (e) => {
    e.target.disabled = true;
    const quantite = parseInt(slider.value);

    await acheterItem(itemId, categorie, quantite);

    await chargerCreditsViaFirestore();
    afficherFeedbackAchat(categorie, item.nom);

    // Mise √† jour du solde dans la popup
    const soldeElement = contenu.querySelector("#solde-joueur");
    if (soldeElement) {
      soldeElement.innerHTML = `<strong>Votre solde :</strong> ${joueurCredits ?? 0} cr√©dits`;
    }

    // Mise √† jour de la liste (si n√©cessaire)
    afficherItemsCategorie(categorie);

    fermerPopup();
  });

  // Clic sur le bouton "Annuler"
  contenu.querySelector("#btn-annuler").addEventListener("click", () => {
    console.log("‚ùå Clic sur Annuler");
    fermerPopup();
  });

  // Clic en dehors de la popup => fermeture
  if (popup._listenerClick) {
    popup.removeEventListener("click", popup._listenerClick);
  }

  popup._listenerClick = (e) => {
    if (!popup.querySelector(".popup-contenu").contains(e.target)) {
      console.log("üßä Clic en dehors du contenu => fermeture");
      fermerPopup();
    }
  };

  popup.addEventListener("click", popup._listenerClick);

  // Affiche la popup
  popup.style.display = "block";
  document.body.classList.add("popup-active");
  console.log("‚úÖ Popup affich√©e");
}

// üîÅ Mise √† jour des items lors du changement de sous-cat√©gorie
document.querySelectorAll(".sous-categorie-select").forEach(select => {
  select.addEventListener("change", e => {
    const categorie = e.target.dataset.categorie;
    const sousCategorie = e.target.value;
    afficherItemsCategorie(categorie, sousCategorie);
  });
});


function fermerPopup() {
  const popup = document.getElementById("popup-item");
  if (popup) {
    popup.style.display = "none";
    document.body.classList.remove("popup-active");
    console.log("üßπ Popup ferm√©e");
  }
}

window.afficherPopupItem = afficherPopupItem;


  // Fonction d‚Äôachat (placeholder pour le moment)
async function acheterItem(itemId, categorie, quantite = 1) {
  console.log(`Achat de ${quantite} x item ${itemId} dans cat√©gorie ${categorie}`);
  const user = auth.currentUser;
  if (!user) {
    alert("Non connect√©");
    return;
  }

  const uid = user.uid;
  const playerDoc = doc(firestore, "players", uid);

  const coffres = {
    ressources: { nom: "coffre_base", max: 7 },
    armes: { nom: "coffre_armes", max: 4 },
    armures: { nom: "coffre_armures", max: 4 },
    cyber: { nom: "coffre_cyber", max: 7 },
    transport: { nom: "coffre_vehicules", max: 3 },
    munitions: { nom: "coffre_munitions", max: 3 },
    drones: { nom: "coffre_drones", max: 2 }
  };

  const coffreInfo = coffres[categorie];
  if (!coffreInfo) {
    alert("‚ùå Cat√©gorie inconnue");
    return;
  }

  try {
    const docSnap = await getDoc(playerDoc);
    const data = docSnap.exists() ? docSnap.data() : {};
    let solde = data.solde ?? 9999;

    // R√©cup√©ration item magasin
    const itemRef = ref(db, `stock-list/${categorie}/${itemId}`);
    const itemSnap = await get(itemRef);
    if (!itemSnap.exists()) {
      alert("‚ùå Item introuvable");
      return;
    }

    const fetchedItem = itemSnap.val();
    const sousCategorie = fetchedItem.sous_categorie;

    // Choix coffre selon sous-cat√©gorie
    let coffreNom = coffreInfo.nom;
    let coffreMax = coffreInfo.max;

    if (["armes_munitions", "armes_munitions_lourdes"].includes(sousCategorie)) {
      coffreNom = "coffre_munitions";
      coffreMax = coffres.munitions.max;
    } else if (sousCategorie === "cyber_drones") {
      coffreNom = "coffre_drones";
      coffreMax = coffres.drones.max;
    }

    let coffre = data[coffreNom] ?? {};

    if ((fetchedItem.stock ?? 0) < quantite) {
      alert("‚ùå Stock insuffisant");
      return;
    }
    if (solde < (fetchedItem.prix ?? 0) * quantite) {
      alert("‚ùå Pas assez de cr√©dits");
      return;
    }

    const estStockable = fetchedItem.estStockable ?? false;
    const stockageLimites = fetchedItem.stockage ?? {};
    const limiteDansCeCoffre = stockageLimites[coffreNom] ?? null;

    // Base item pour ajout dans coffre
    const baseItem = {
    id: itemId,
  nom: fetchedItem.nom ?? "Objet inconnu",
  image: fetchedItem.image ?? null,
  prix: fetchedItem.prix ?? 0,
  rarete: fetchedItem.rarete ?? null,
  type: fetchedItem.type ?? null,
  description: fetchedItem.description ?? null,
  estStockable: estStockable,
  stockage: stockageLimites,
  sous_categorie: fetchedItem.sous_categorie ?? null,
  stats: fetchedItem.stats ?? null,
  quantite: 1 // √† ajuster selon le contexte
    };

    let slotTrouve = null;
    let dejaLa = false;

    // 1) Recherche slot contenant item identique (pour stacker si possible)
    for (let i = 0; i < coffreMax; i++) {
      const slot = `slot${i}`;
      const contenu = coffre[slot];

      if (contenu?.id === itemId && estStockable) {
        slotTrouve = slot;
        dejaLa = true;
        break;
      }

      // Sinon rep√©rer premier slot vide possible
      if (!contenu && slotTrouve === null) {
        slotTrouve = slot;
      }
    }

    // 2) Si pas d√©j√† l√† et plus de place -> alerte
    if (!dejaLa) {
      const slotsUtilises = Object.values(coffre).filter(obj => obj && typeof obj === "object").length;
      if (slotsUtilises >= coffreMax) {
        alert(`‚ùå Vous ne pouvez pas poss√©der plus de ${coffreMax} types d‚Äô${categorie}.`);
        return;
      }
    }

    // 3) Calcul solde restant apr√®s achat
    solde -= (fetchedItem.prix ?? 0) * quantite;
    const majData = { solde };

    // 4) Si stackable et item d√©j√† dans un slot -> ajouter quantit√© en respectant limite
    if (dejaLa && estStockable) {
      const quantiteActuelle = coffre[slotTrouve].quantite ?? 0;
      const nouvelleQuantite = quantiteActuelle + quantite;

      if (limiteDansCeCoffre !== null && nouvelleQuantite > limiteDansCeCoffre) {
        alert(`‚ùå Limite de stockage (${limiteDansCeCoffre}) atteinte pour cet item.`);
        return;
      }

      majData[coffreNom] = {
        ...coffre,
        [slotTrouve]: {
          ...coffre[slotTrouve],
          quantite: nouvelleQuantite
        }
      };

    } else if (!estStockable) {
      // 5) Si NON stackable, chaque item occupe un slot : on doit cr√©er autant de slots que quantit√©
      // V√©rifier si assez de slots libres :
      const slotsLibres = [];
      for (let i = 0; i < coffreMax; i++) {
        const slot = `slot${i}`;
        if (!coffre[slot]) slotsLibres.push(slot);
      }
      if (slotsLibres.length < quantite) {
        alert(`‚ùå Pas assez de place dans le coffre pour ${quantite} items non stackables.`);
        return;
      }

      // Construire nouvel objet coffre avec ajout de chaque item dans un slot libre
      const nouveauCoffre = { ...coffre };
      for (let j = 0; j < quantite; j++) {
        const slotAjout = slotsLibres[j];
        nouveauCoffre[slotAjout] = {
          ...baseItem,
          quantite: 1 // toujours 1 car non stackable
        };
      }

      majData[coffreNom] = nouveauCoffre;

    } else {
      // 6) Item stackable mais pas encore en coffre -> on ajoute en un slot
      if (limiteDansCeCoffre !== null && quantite > limiteDansCeCoffre) {
        alert(`‚ùå Limite de stockage (${limiteDansCeCoffre}) atteinte pour cet item.`);
        return;
      }

      majData[coffreNom] = {
        ...coffre,
        [slotTrouve]: {
          ...baseItem,
          quantite: quantite
        }
      };
    }

    // 7) Mise √† jour Firestore
    await setDoc(playerDoc, majData, { merge: true });

    // 8) Mise √† jour stock magasin
    const stockRestant = Math.max((fetchedItem.stock ?? 1) - quantite, 0);
    await update(itemRef, { stock: stockRestant });

    afficherItemsCategorie(categorie);

  } catch (e) {
    console.error("‚ùå Erreur pendant l'achat :", { e, itemId, categorie, uid });
    alert("Erreur pendant l'achat.");
  }
}

async function getStockItem(categorie, itemId) {
  const itemRef = ref(db, `stock-list/${categorie}/${itemId}`);
  const snapshot = await get(itemRef);
  if (!snapshot.exists()) return 0;
  const data = snapshot.val();
  return data.stock ?? 0;
}



function afficherFeedbackAchat(categorie, nomItem) {
  const container = document.querySelector(`.stock-list[data-categorie="${categorie}"]`);
  if (!container) return;

  // Supprime feedbacks pr√©c√©dents pour √©viter accumulation
  const anciens = container.querySelectorAll(".achat-feedback");
  anciens.forEach(el => el.remove());

  const feedback = document.createElement("div");
  feedback.className = "achat-feedback";
  feedback.innerText = `‚úÖ ${nomItem} achet√© !`;

  container.appendChild(feedback);

  // Forcer un reflow pour d√©clencher la transition CSS
  void feedback.offsetWidth;

  feedback.classList.add("visible");

  setTimeout(() => {
    feedback.classList.remove("visible");
    setTimeout(() => feedback.remove(), 300); // temps du fade out
  }, 2000);
}




function getImagePath(nomImage) {
  const chemin = nomImage?.startsWith("http")
    ? nomImage
    : `images/assets/${nomImage}`;

  // Optionnel ‚Äî retour fallback si image ne charge pas
  const img = new Image();
  img.src = chemin;
  img.onerror = () => {
    img.src = "images/default.png";
  };

  return chemin;
}



//argent joueur
let joueurCredits = 0;

// üîÑ Charger le cr√©dit du joueur
async function chargerCreditsViaFirestore() {
  const user = auth.currentUser;
  if (!user) return;

  const userRef = doc(firestore, "players", user.uid);
  const snap = await getDoc(userRef);

  if (snap.exists()) {
    const data = snap.data();
    joueurCredits = data.solde || 0;
    console.log("üí∞ Cr√©dit joueur (Firestore) :", joueurCredits ?? "inconnu");
    mettreAJourAffichageCredits();
  } else {
    joueurCredits = 0;
    console.warn("‚ùå Utilisateur sans donn√©es dans Firestore");
    mettreAJourAffichageCredits();
  }
}

// Fonction pour ouvrir le pop-up avec les informations de l'item



// üîÅ Mise √† jour de l'affichage dans l'UI
function mettreAJourAffichageCredits() {
  const creditElement = document.querySelector('#credit-affiche');
  if (creditElement) {
    creditElement.textContent = joueurCredits + " cr√©dits";

    // üí• Ajout de l'effet visuel "pulse"
    creditElement.classList.add("neonPulse");
    setTimeout(() => creditElement.classList.remove("neonPulse"), 500);
  }
}



document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    const onglet = tab.dataset.onglet;

    // Retirer active sur tous les onglets et contenus
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(tc => tc.classList.remove("active"));

    // Ajouter active sur l'onglet cliqu√©
    tab.classList.add("active");
    document.getElementById(onglet).classList.add("active");
  });
});

function clearActiveTabs() {
  buttons.forEach(b => b.classList.remove('active'));
  tabs   .forEach(t => t.classList.remove('active'));
}





// Appelle une fois pour charger la cat√©gorie par d√©faut au d√©marrage
const coffres = {
  ressources: { nom: "coffre_base", max: 7 },
  armes: { nom: "coffre_armes", max: 4 },
  armures: { nom: "coffre_armures", max: 4 },
  cyber: { nom: "coffre_cyber", max: 7 },
  transport: { nom: "coffre_vehicules", max: 3 },
  munitions: { nom:"coffre_munitions", max: 3}  ,
  drones: { nom:"coffre_drones", max: 2}
};




async function chargerItems() {
  const playerID = currentUID; 
  const select = document.getElementById("categorie-select");
  const coffreNom = select.value;
  const container = document.getElementById("items-container");

  console.log("üîé Chargement des items pour :", playerID);
  console.log("üì¶ Coffre s√©lectionn√© :", coffreNom);

  container.innerHTML = "<p>Chargement...</p>";

  if (!coffreNom) {
    container.innerHTML = "<p>Veuillez choisir une cat√©gorie.</p>";
    return;
  }

  try {
    // R√©cup√®re le document complet du joueur
    const docRef = doc(firestore, "players", playerID);
    const snapshot = await getDoc(docRef);

    if (!snapshot.exists()) {
      console.log("üì≠ Document joueur introuvable :", playerID);
      container.innerHTML = "<p>Impossible de charger l'inventaire.</p>";
      return;
    }

    const data = snapshot.data();
    const coffre = data[coffreNom]; // Ex: data["coffre_armes"]

    if (!coffre || Object.keys(coffre).length === 0) {
      console.log("üì≠ Coffre vide :", coffreNom);
      container.innerHTML = "<p>Aucun objet dans ce coffre.</p>";
      return;
    }

    container.innerHTML = "";

    Object.entries(coffre).forEach(([slot, item]) => {
      if (!item || item.quantite <= 0) return;

      const itemDiv = document.createElement("div");
      itemDiv.className = "item-card";
      itemDiv.innerHTML = `
        <img src="${item.icone || item.image}" alt="${item.nom}" />
        <h3>${item.nom}</h3>
        
        <p>Quantit√© : ${item.quantite}</p>
        <p>Type : ${coffreNom.replace("coffre_", "")}</p>
      `;

      itemDiv.addEventListener("click", () => {
        ouvrirPopupRevente(item.nom, item.id, slot, item.prix, item.quantite, coffreNom.replace("coffre_", ""));
      });

      container.appendChild(itemDiv);
    });

  } catch (error) {
    console.error("üî• Erreur Firestore :", error);
    container.innerHTML = "<p>Erreur lors du chargement des objets.</p>";
  }
}


window.chargerItems = chargerItems;

(() => {


function ouvrirPopupRevente(nom, id, slot, prix, max, categorie) {
  console.log("Tentative d'ouverture popup pour l'item :", id);
  
  currentItemID = id;
  currentCategorie = categorie;
  currentPrixUnitaire = prix;
  itemMax = max;
  quantite = 1;

  document.getElementById("popup-nom-revente").textContent = nom;
  document.getElementById("quantite-valeur-revente").textContent = quantite;
  document.getElementById("slider-revente").max = itemMax;
  document.getElementById("slider-revente").value = quantite;

  const gain = Math.floor(quantite * currentPrixUnitaire * 0.7);
  document.getElementById("gain-valeur-revente").textContent = gain;

  document.querySelector(".popup-vente").style.display = "block";
}

window.ouvrirPopupRevente = ouvrirPopupRevente;
window.validerVente = validerVente;



let currentItemID = null;
let currentCategorie = "";
let currentPrixUnitaire = 0;
let itemMax = 0;
let quantite = 1;

const coffres = {
  armes: { nom: "coffre_armes" },
  armures: { nom: "coffre_armures" },
  cyber: { nom: "coffre_cyber" },
  ressources: { nom: "coffre_ressources" },
  transports: { nom: "coffre_vehicules" },
  base: { nom: "coffre_base" },
  safe: { nom: "coffre_safe" },
   munitions: { nom:"coffre_munitions"},
   drones: { nom:"coffre_drones"}
};

async function validerVente() {
  const user = auth.currentUser;
  if (!user) {
    alert("Utilisateur non connect√© !");
    return;
  }

  const uid = user.uid;
  const quantiteVendue = parseInt(document.getElementById("slider-revente").value);
  if (isNaN(quantiteVendue) || quantiteVendue <= 0) {
    alert("Quantit√© invalide !");
    return;
  }

  try {
    console.log("üß† currentItemID :", currentItemID);
    console.log("üì¶ currentCategorie :", currentCategorie);

    // 1. üî• R√©cup√©ration des donn√©es joueur
    const playerRef = doc(firestore, "players", uid);
    const playerSnap = await getDoc(playerRef);
    if (!playerSnap.exists()) throw new Error("Joueur introuvable");

    const data = playerSnap.data();
    console.log("üì¶ Donn√©es joueur :", data);

    // 2. üîê V√©rifie la cat√©gorie
    if (!coffres[currentCategorie]) {
      alert("Cat√©gorie inconnue : " + currentCategorie);
      return;
    }

    const coffreNom = coffres[currentCategorie].nom;
    const coffre = data[coffreNom];
    console.log("üìÅ Coffre s√©lectionn√© :", coffreNom, coffre);

if (!coffre || typeof coffre !== 'object') {
  alert("Coffre vide ou invalide !");
  return;
}

let slotTrouve = null;
for (const [slot, item] of Object.entries(coffre)) {
  if (!item) continue;
  if (item.id === currentItemID) {
    slotTrouve = slot;
    break;
  }
}

if (slotTrouve === null) {
  alert("Item introuvable dans votre inventaire !");
  console.warn("‚ùå Aucun item avec l'id", currentItemID, "dans", coffreNom);
  return;
}

    // 4. ‚úÇÔ∏è Maj quantit√© ou suppression
const newQuantite = coffre[slotTrouve].quantite - quantiteVendue;
if (newQuantite <= 0) {
  delete coffre[slotTrouve];
} else {
  coffre[slotTrouve].quantite = newQuantite;
}

    // 5. ‚úÖ Mise √† jour dans Firestore
    await updateDoc(playerRef, { [coffreNom]: coffre });
    console.log("üì§ Coffre mis √† jour dans Firestore");

    // 6. üíæ Mise √† jour dans Realtime DB (stock magasin)
    
const itemPath = `stock-list/${currentCategorie}/${currentItemID}`;
const itemRef = ref(realtimeDB, itemPath);
const itemSnap = await get(itemRef);
const ancienneQuantite = itemSnap.exists() ? itemSnap.val().stock || 0 : 0;
const nouvelleQuantite = ancienneQuantite + quantiteVendue;

console.log("üíæ Mise √† jour de RealtimeDB √† :", itemPath, "‚Üí", {
  stock: nouvelleQuantite,
  prix: currentPrixUnitaire
});

await update(itemRef, {
  stock: nouvelleQuantite,
  prix: currentPrixUnitaire
});

    console.log("üìä Mise √† jour Realtime DB :", itemPath, "->", nouvelleQuantite, "au prix de", currentPrixUnitaire);

    alert("Vente effectu√©e !");
    fermerPopupRevente();
    chargerItems();

  } catch (error) {
    console.error("üö® Erreur durant la vente :", error);
    alert("Erreur pendant la vente.");
  }
}

function updateQuantiteRevente(valeur) {
  quantite = parseInt(valeur);
  document.getElementById("quantite-valeur-revente").textContent = quantite;

  const gain = Math.floor(quantite * currentPrixUnitaire * 0.7);
  document.getElementById("gain-valeur-revente").textContent = gain;
}

window.updateQuantiteRevente = updateQuantiteRevente;




function fermerPopupRevente() {
  document.querySelector(".popup-vente").style.display = "none";
  currentItemID = null;
  currentCategorie = null;
  currentPrixUnitaire = null;
  itemMax = 1;
  quantite = 1;
}
window.fermerPopupRevente = fermerPopupRevente;

// üëá Ajoute ceci juste apr√®s, toujours dans le m√™me bloc principal
document.addEventListener("click", function (event) {
  const popup = document.querySelector(".popup-vente");
  const content = document.querySelector(".popup-content");

  if (
    popup.classList.contains("show") &&
    !content.contains(event.target) &&
  
    !event.target.closest("[data-ignore-popup-close]")
    
  ) {
     
    fermerPopupRevente();
  }
});

})(); // ‚Üê C'√©tait cette parenth√®se + accolade finale qui manquait

       

async function demarrerCountdownReset() {
  const resetRef = ref(db, "stockReset/lastReset");
  const snapshot = await get(resetRef);

  if (!snapshot.exists()) {
    console.error("‚õî Aucun lastReset trouv√© dans stockReset !");
    return;
  }

  const lastReset = snapshot.val();
  console.log("‚è≤Ô∏è Last reset timestamp:", lastReset);
  const countdownElements = document.querySelectorAll('.stock-timer .countdown');
  const labelElements = document.querySelectorAll('.stock-timer .countdown-label');



console.warn("‚õî Pas d'√©l√©ments countdown trouv√©s !")
  if (!countdownElements.length || !labelElements.length) return;

  labelElements.forEach(el => el.textContent = "‚è≥ Prochain r√©approvisionnement dans :");

  let resetEffectue = false;

  function updateCountdown() {
    const now = Date.now();
    const prochainReset = lastReset + 3 * 24 * 60 * 60 * 1000;
    const diff = prochainReset - now;

    let timeStr = "00:00:00";

    if (diff > 0) {
      const heures = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const secondes = Math.floor((diff % (1000 * 60)) / 1000);
      const format = n => n.toString().padStart(2, "0");
      timeStr = `${format(heures)}:${format(minutes)}:${format(secondes)}`;
    } else if (!resetEffectue) {
      resetEffectue = true;
      effectuerResetStock();
    }

    countdownElements.forEach(el => el.textContent = timeStr);
  }

  updateCountdown();
  setInterval(updateCountdown, 1000);
}

window.addEventListener("DOMContentLoaded", () => {
  demarrerCountdownReset();
});

 async function effectuerResetStock() {
  const db = getDatabase();
  const stockRef = ref(db, "stock-list");

  try {
    const snapshot = await get(stockRef);
    if (!snapshot.exists()) {
      console.warn("Aucun stock √† r√©initialiser.");
      return;
    }

    const updates = {};
    const stockData = snapshot.val();

    for (const categorie in stockData) {
      const items = stockData[categorie];

      for (const itemID in items) {
        const item = items[itemID];
        if (item.stockMax !== undefined) {
          updates[`stock-list/${categorie}/${itemID}/stock`] = item.stockMax;
          console.log(`üîÑ ${itemID} (${categorie}) ‚Üí stockMax: ${item.stockMax}`);
        }
      }
    }

    console.log("Mise √† jour en cours :", updates);

    await update(ref(db), updates);

    await set(ref(db, "stockReset/lastReset"), Date.now());

    console.log("‚úÖ Stock r√©initialis√© !");
  } catch (error) {
    console.error("‚ùå Erreur lors du reset du stock :", error);
  }
}


function updateCountdown() {
  const now = Date.now();
  const diff = prochainReset - now;

  let timeStr;
  if (diff <= 0) {
    timeStr = "00:00:00";

    // D√©clenche le reset une seule fois
    if (!resetEffectue) {
      resetEffectue = true;
      effectuerResetStock(); // Tu dois avoir cette fonction quelque part dans un <script type="module">
    }

  } else {
    const heures = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const secondes = Math.floor((diff % (1000 * 60)) / 1000);

    const format = n => n.toString().padStart(2, "0");
    timeStr = `${format(heures)}:${format(minutes)}:${format(secondes)}`;
  }

  countdownElements.forEach(el => el.textContent = timeStr);
}



</script>
</body>


 <div id="popup-item" style="display: none">
    <div class="popup-contenu"></div>
  </div>
</html>
